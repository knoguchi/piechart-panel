{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","renderingCompleted","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","formatter","label","slice","fontSize","color","Math","round","percent","addPieChart","width","size","min","plotCanvas","plotCss","top","margin","position","$panelContainer","parents","backgroundColor","dataset","options","legend","show","grid","hoverable","clickable","pieType","series","pie","stroke","parseFloat","strokeWidth","toFixed","legendType","highlight","opacity","innerRadius","ticks","maxLen","length","i","push","bars","horizontal","align","barWidth","max_value","max","map","decimals","floor","abs","log10","xaxis","tickFormatter","v","axis","formatValue","yaxis","borderWidth","labelMargin","html","plot","bind","event","pos","item","detach","body","formatted","dataIndex","place_tt","pageX","pageY"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var $panelContainer = elem.parents('.panel-container');\n    var backgroundColor = $panelContainer.css('background-color');\n\n    var dataset = ctrl.data;\n    var options = {\n      legend: {\n        show: false\n      },\n      grid: {\n        hoverable: true,\n        clickable: false\n      }\n    };\n\n    if (panel.pieType === 'pie' || panel.pieType == 'donut') {\n      options.series = {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          }\n        }\n      };\n      if (panel.pieType === 'donut') {\n        options.series.pie.innerRadius = 0.5;\n      }\n    } else if (panel.pieType === 'bar') {\n      // transform data structure\n      var data = [];\n      var ticks = [];\n      var maxLen = ctrl.data.length;\n      for(var i=0; i< maxLen; i++) {\n        ticks.push([maxLen-i, ctrl.data[i].label]);\n        data.push([ctrl.data[i].data, maxLen-i]);\n      }\n\n      options.series = {\n        bars: {\n          show: true,\n          horizontal: true\n        }\n      };\n\n      options.bars = {\n        align: \"center\",\n        barWidth: 0.5\n      };\n\n      dataset = [\n        {data: data, color: \"#5482ff\"}\n      ];\n\n      var max_value = _.max(_.map(data, function(e) { return e[0];}));\n      panel.decimals = Math.floor(Math.abs(Math.log10(max_value)));\n\n      options.xaxis = {\n        max: _.min([max_value * 1.2, 1.0]),\n        tickFormatter: function (v, axis) {\n          return ctrl.formatValue(v);\n        }\n      };\n\n      options.yaxis = {\n        ticks: ticks\n      };\n\n      options.grid.borderWidth = 0;\n      options.grid.labelMargin = 5;\n    }\n\n    elem.html(plotCanvas);\n    $.plot(plotCanvas, dataset, options);\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\n      if (!item) {\n        $tooltip.detach();\n        return;\n      }\n\n      var body;\n      var formatted = ctrl.formatValue(item.series.data[item.dataIndex][0]);\n\n      body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\n      body += '<div class=\"graph-tooltip-value\" style=\"text-overflow: ellipsis\">' + item.series.yaxis.ticks[item.dataIndex].label;\n      body += \" \" + formatted + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n    });\n  }\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      addPieChart();\n    }\n  }\n}\n\n"]}